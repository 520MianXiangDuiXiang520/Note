# Redis其他功能之————慢查询

如果一条命令的**执行时间**超过了某个阈值，这条查询语句就被叫做“慢查询”，Redis会把这条命令加入到一个队列（基于Redis列表实现）中，这个队列是固定长度的，如果队列满了，队首的语句就会被弹出队列。

<!-- more -->

一条Redis命令的生命周期：
1. 客户端通过网络想Redis服务端发送一条命令
2. 由于Redis是单线程的，所以如果前面有正在执行的命令，这条命令就需要在“等待队列”中排队等待
3. 执行命令
4. 服务端把执行结果通过网络返回给客户端

需要注意的是：

1. 决定一条查询是不是慢查询的是这条语句的**执行时间**，从客户端传到服务端的网络传输时间以及排队时间是不算的。
2. 客户端超时不一定慢查询，但慢查询是客户端超时的一个可能因素
3. 慢查询队列保存在内存中，不会做持久化，Redis重启后会消失

## 配置

### 通过配置文件

修改配置文件`redis.conf`中下面几个字段来修改慢查询相关配置

```conf
# 慢查询队列的长度
slowlog-max-len

# 慢查询阈值，执行时间超过这个阈值就会被定义为慢查询     
slowlog-log-slower-than

# 慢查询记录
slowlog list
```

* 如果把slowlog-log-slower-than设置为0，则记录所有语句，设置为负数则不记录任何语句。
* 修改配置文件之后需要重启Redis服务，生产环境不建议直接修改配置文件
* slowlog-max-len 不要太小，一般1000左右
* slowlog-log-slower-than 不要太大，默认10ms，一般设置为1ms

### 动态配置

1. 获取配置信息

```shell
config get 配置名
```

如

```shell
127.0.0.1:6379> config get port
1) "port"
2) "8100"
```

2. 修改配置

```shell
config set 配置名 新配置值
```

如：

```shell
127.0.0.1:6379> config set slowlog-max-len 1000
OK
```

## 慢查询日志

Redis提供了三条命令来操作慢查询队列，分别是：

1. slowlog get [n] ：查看当前的慢查询队列，长度通过n指定

```txt
1) 慢查询记录 id；
2) 发起命令的时间戳；
3) 命令耗时，单位为微秒；
4) 该条记录的命令及参数；
5) 客户端网络套接字（ip: port）;
6) “”
```

2. slowlog len: 获取当前队列长度
3. slowlog reset: 清空慢查询队列