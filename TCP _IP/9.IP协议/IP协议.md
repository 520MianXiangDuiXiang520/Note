

## 网络层与数据链路层之间的关系
数据链路层用于两个直连的设备之间的通信  
网络层用于没有直连的，两个网络之间的通信传输  
知乎上有一个形象的比喻
>简单地说，为了实现跨越互联网的，主机 A 的进程 P1，和主机 B 的进程 P2 之间的通信，我们逐层把这个任务交给 TCP/IP 协议栈。
>
>运输层：“如果有人能帮我把数据从某个网络中的机器 A 搬到另一个网络中的机器 B，我就可以搞定这个任务，因为我知道不同的数据应该交给机器上的哪个进程。”
>
>网络层：“如果有人能帮我把数据从局域网中直接相连的一台机器搬到另一台机器，我就可以把数据从一个网络搬到另一个网络，因为我知道路线怎么走，要经过哪些节点。”
>
>链路层：“我知道怎样在局域网中搬数据，还能用 CSMA/CD 协议协调工作，还能用 CRC32 校验发送的数据和接收的数据是一致的，blabla...  But，我只是说说，我不干苦力活。”
>
>物理层：“楼上的大爷们发话了，兄弟们上。”
>
>作者：dastan du
>链接：https://www.zhihu.com/question/29949319/answer/46248356
>来源：知乎
>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

* 跳
  主机或路由器网卡不经过其他路由器而能直接到达的相邻主机或路由器网卡之间的一个区间。

## 路由控制

路由控制是指将分组数据发送到最终目标地址的功能

如果只有IP地址，是无法完成通信的，就像只知道地址但不知道路一样，要想使数据正确到达目标地址，还需要一张表，他记录了“指明路由器或主机的信息”这张表就是路由控制表，路由控制表有静态和动态两种，静态路由控制表是由管理员手动输入的，而动态路由控制表是路由器在与其他路由器交换信息时自动刷新的，IP协议认为所有的路由控制表都是正确的，他不具备更新路由控制表的功能，所以需要别的协议来完成路由控制表的更新，这就是路由控制协议。  

在发送IP包时，首先解析出包首部包含的目标地址，再从路由控制表中找出与该地址具有相同网络地址的记录，再根据该记录将IP包转发给相应的路由器，如果由多条相匹配的记录，就选择相同位数最多的。
## IP分片处理
由于不同数据链路的最大传输单位（MTU）不同，如在以太网中是1500字节，FDDI是4352字节，ATM则是9180字节，鉴于IP属于数据链路上一层，他必须不受限于MTU，否则就无法传输，对此，IP抽象了底层的数据链路，具体方法就是做分片处理，然后在终点端重组分片，
### 路径MTU发现
IP分片处理有许多缺点，如会加重路由器负荷，如果一个分片丢失整个数据包都会作废等，为此，产生了一种新技术 “路径MTU发现”　路径MTU是指从发送端主机到接收端主机不需要分片时最大的MTU大小，路径MTU发现从发送主机按照路径MTU的大小将数据报分片后进行发送，进行路径MTU发现，可以避免在中途路由器上进行分片处理，也可以在TCP中发送更大的包。

## IP地址
### 定义：
IP地址，网际协议地址，他是IP协议提供的一种统一的地址格式，为互联网上的每一台主机或网络提供一个逻辑地址，用来屏蔽物理地址（MAC）的差异，它由32位的二进制数字组成，一般以八位为一组用'.'隔开，再换算成十进制数字。如 134.175.69.122，其表示为

|134|175|69|122|
|---|----|--|---|
|10000110|10101111|1000101|1111010|

IP地址由两部分组成，网络地址和主机地址，不同分类的IP地址网络地址与主机地址所占的字节各不相同，相互连接的每个段的网络地址不能相同，但同一段的主机必须具有相同的网络地址，而主机地址则不允许相同。
### 分类：
IP地址被分为五类，分别是 ABCDE

|分类|范围|主机地址上限|标志|
|----|---|-----------|---|
|A类|0.0.0.0 ~ 127.0.0.0|16777214|第一位值为0|
|B类|128.0.0.0 ~ 191.225.0.0|65534|前两位值为10|
|C类|192.0.0.0 ~ 223.225.225.0|254|前三位值为110|
|D类|224.0.0.0 ~ 239.225.225.225|用于多播，没有主机标志|前四位值为1110|
|E类|未使用||

* 主机地址上限的计算方法：
  不同种类的IP地址网络标志和主机标志所占的字节数不同

  |分类|网络标志所占字节|主机标志所占字节|
  |----|--------------|---------------|
  |A类|8比特|24比特|
  |B类|16 比特|16 比特|
  |C类|24 比特|8 比特|
  |D类|32 比特|——|

  以A类IP地址为例，A类网络标志占8字节，而第一位值是确定的，为 0 ，所以其网络地址分布为 00000000 ~ 01111111 换算成十进制就是 0 ~ 127，总共128个，但其中0和127被保留，因此只有126个网络地址，在网络标志之后有24个字节的主机标志，即 00000000.00000000.00000000 ~ 11111111.11111111.11111111 总共 `2**24=16777216`个主机地址，但全为0和全为1的地址被保留，前者在IP地址不可知时使用，后者常用作广播地址，所以只有16777214个主机地址，其他分类类似。

  |分类|网络地址数|主机地址数|
  |-|-|-|
  |A类|126个|16777216个|
  |B类|16382个|65534个|
  |C类|2097150个|254个|

### 广播和IP多播：
* 广播：之前说过，把IP地址的主机部分全部设置为1就称为了广播地址。广播分为本地广播和直接广播两种，在本网络内的广播叫做本地广播，不同网络之间的广播叫做直接广播。
* IP多播：是一种允许一台或多台主机（多播源）发送单一数据包到多台主机（一次的，同时的）的TCP/IP网络技术。多播使用D类地址，因此，除了前四位1110外，剩余的28为就是多播组编号。  从224.0.0.0到239.225.225.225 都是多播地址的可用范围，其中224.0.0.0到224.0.0.225的范围不需要路由控制。在同一个链路内也能实现多播，而在这个范围之外设置多播地址会给全网所有组内成员发送多播的包，这时可以使用TTL（生存时间）设置范围。

### 子网掩码：

#### 定义：

用 ‘1’表示IP**网络地址**的比特范围，用‘0’表示IP**主机地址**范围，将他们以十进制表示，对于A类地址来说，默认的子网掩码是255.0.0.0；对于B类地址来说默认的子网掩码是255.255.0.0；对于C类地址来说默认的子网掩码是255.255.255.0。  

子网掩码和IP地址一样，由32位二进制数字组成，不过子网掩码要求1和0必须连续，1代表网络地址，0代表主机地址，左边是主机位，右边是网络位，以A类地址为例，A类地址网络标志占8个字节，主机标志占24字节，所以默认掩码为：11111111.00000000.00000000.00000000 转换为十进制就是255.0.0.0

子网掩码有两种表示方法，以172.20.100.52为例：第一种方法就是把IP地址和子网掩码分两行书写，

```
IP地址     172.     20.     100.     52
子网掩码   255.     255.    255.     192

网络地址   172.     20.     100.     0
子网掩码   255.     255.    255.     192

广播地址   172.     20.     100.     69
子网掩码   255.     255.    255.     192

```
另一种方法是在IP地址的后面追加网络地址的位数，如：  

```
IP地址     172.     20.     100.     52     /26
网络地址   172.     20.     100.     0      /26
广播地址   172.     20.     100.     69     /26
```
这个 26 就是子网掩码中1的个数...


#### 作用：
子网掩码的作用有两个，其一是用来区分IP地址的网络标志和主机标志，其二是将一个大的IP网络划分为若干个小的子网络。  
对于第一个功能，知乎上看过一个解释，就是类似于姓名，如果有两个人都叫司马光，一个来自司马村，一个来自司村，如何区分这两个人呢？他们在自报家门是只要说我叫司马光，姓司马，就可以知道它来自司马村，另一个只要说我叫司马光，姓司，就也可以知道它来自司村了。IP地址也一样。如果直接使用IP地址的话，显然会造成一些浪费，且对IP地址的需求也会越来越多，子网掩码就是提供了一种新的组合方式以减少这种浪费。

#### 计算方法：
子网掩码的计算方法有三种，根据子网数，根据主机数，增量计算法。
##### 根据子网数计算
1. 将子网数目转换成二进制
2. 看子网数目二进制的数为N
3. 取得该IP地址的类子网掩码
4. 将其主机部分的前N位置1，即可得出子网掩码

例：欲将B类IP地址划分位30个子网，30化为二进制是11110位数N为5，B类IP地址类子网掩码是255.255.0.0，把主机地址的前五位置为1，主机地址就是 11111000，00000000 化为十进制就是248.0 所以子网掩码就是255.255.248.0

**注意：** 在新标准中，子网数需要先减去1，应为计算机是从0开始计算的，不减的话，从0到30实际上是由31个的

##### 根据主机数计算
1. 将主机数化为二进制
2. 把主机数化为二进制，取得数为N
3. 将地址全部置为1，即255.255.255.255
4. 从后往前把N位数字置为0，得出子网掩码

例：B类IP地址134.175.0.0要划分成若干子网，每个子网内有主机700台，
1. 把700化为二进制10 10 11 11 00，N=10
2. 把11111111.11111111.11111111.11111111后10位换成0得11111111.11111111.11111100.00000000
3. 转换成十进制 255.255.252.0

##### 增量计算法
1. 将所需的子网数转换为二进制
2. 取子网数的二进制中有效位数
3. 决定子网掩码
4. 求子网ID增量，将所借位的主机ID的起始位段最右边的“1”转换为十进制，即为每个子网ID之间的增量，如借位的主机ID起始位段为“11100000”，最右边的“1”，转换成十进制后为2^5=32（此为子网ID增量）。
5. 产生的子网ID数为：2^m-2 （m为向缺省子网掩码中加入的位数）；
6. 将上面产生的子网ID增量附在原网络ID之后的第一个位段，便形成第一个子网网络ID 129.20.32.0（即第一个子网的起始IP段）；
7. 重复上步操作，在原子网ID基础上加上一个子网ID增量，依次类推，直到子网ID中的最后位段为缺省子网掩码位用主机ID位之后的最后一个位段值，这样就可得到所有的子网网络ID。


#### 标注方法
##### 无子网
对无子网的IP地址，可写成主机号为0的掩码。如IP地址210.73.140.5，掩码为255.255.255.0，也可以缺省掩码，只写IP地址。
##### 有子网

有子网时，一定要二者配对出现。以C类地址为例。
以下一段指定掩码为27位(1111 1111, 1111 1111, 1111 1111, 1110 0000=>255.255.255.224
1. IP地址中的前3个字节表示网络号，后一个字节既表明子网号，又说明主机号，还说明两个IP地址是否属于同一个网段。如果属于同一网络区间，这两个地址间的信息交换就不通过路由器。如果不属同一网络区间，也就是子网号不同，两个地址的信息交换就要通过路由器进行。
   例如：
对于IP地址为210.73.140.5的主机来说，其主机标识为5=>00000101，
对于IP地址为210.73.140.16的主机来说它的主机标识为16=>00010000，
以上两个主机标识的前面三位全是000，说明这两个IP地址在同一个网络区域中，这两台主机在交换信息时不需要通过路由器进行。
210.73.60.1的主机标识为1=>00000001，
210.73.60.252的主机标识为252=>11111100，
这两个主机标识的前面三位000与111不同，说明二者在不同的网络区域，要交换信息需要通过路由器。其子网上主机号各为1和252。

2. 掩码的功用是说明有子网和有几个子网，但子网数只能表示为一个范围，不能确切讲具体几个子网，掩码不说明具体子网号，有子网的掩码格式(对C类地址)。

## IPv6
IPv6 是为了解决IPV4地址耗尽问题而被提出的，IPv6的地址长度是原来的4倍，即128比特，一般写为8个16位字节。
### 特点
* IP地址的扩大和路由控制表的聚合
* 性能的提升
  包首部采用固定（40）值，放弃首部检验码，简化首部结构，减轻路由器负荷，采用路径MTU发现，路由器不再做分片操作
* 支持即插即用功能
  即使没有DHCP服务器也可以自动分配IP地址
* 采用认证与加密功能
* 多播，Mobile IP成为拓展功能

## IPv4与IPv6首部
在数据通信时，需要在数据前面加上IP首部信息，其中包含着用于IP协议进行发包控制时所有的必要信息。

### IPv4首部
包括 版本，首部长度（IHL），区分服务（TOS），总长度，标识（ID），标志（Flags），片漂移（FO），生存时间（TTL），协议，总部校验和，源地址，目标地址，可选项，填充，14部分组成

|名称|作用|大小|
|----|---|----|
|版本|标志IP首部版本号|4比特|
|IHL|标明IP首部大小|单位是4字节（32比特），没有可选项时，大小是 “5”（20字节）|
|TOS|标明服务质量|8比特|
|总长度|标明IP首部与数据合起来的总大小|16比特|
|ID|用于分片重组|16比特|
|Flags|表示包被分片的相关信息，第一位必须是0，第二位0表示可以分片，1表示不能，第三位是在被分片的情况下表示是否是最后一个包|3比特|
|FO|标志被分片的每一个分段相对于原始数据的位置|13比特|
|TTL|指可以转换多少个路由器的意思|8比特|
|协议|IP包传输层的上层协议编号|8比特|
|首部校验和|校验数据包首部，确保数据报不被破坏|16比特|
|源地址|发送端IP地址|32比特|
|目标地址|目标IP地址|32比特|
|可选项|用作实验或诊断包括安全级别，原路径，路径记录，时间戳|长度可变|
|填充|在有可选项的情况下，通过填充使首部长度是32的整数倍|可变|
|数据|存入数据||

### IPv6首部

包括 版本，通信量类，流标号，有效载荷长度，下一个首部，跳数限制，源地址，目标地址

|名称|功能|大小|
|-|-|-|
|版本|与IPv4一样，TPv6版本号为6|4比特|
|通信量类|类似于TOS|8比特|
|流标号|准备用于质量服务，只有源地址，目标地址，流标号完全一致使才被认为是一个流|20比特|
|有效载荷长度|包的数据部分||
|下一个首部|相当于协议等，表示IP上一层协议是YCP或UDP|8比特|
|跳数限制|相当于TTL|8比特|
|源地址|源IP地址|128比特|
|目标地址|目标IP地址|128比特|
